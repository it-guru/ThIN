<!DOCTYPE html>
<html lang="en-US" style="height: 100%;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>ThIN:psock.fritz.box</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="../img/ThIN-mini.gif" type="image/gif" />
<script src="../js/spin.js"></script><script src="/js/require.js"></script>
<style>
fieldset.main{overflow:auto;padding:1.0em 3em 1.8em 1.8em;border:1px solid #4CAF50;background-color:white;margin:20px;border-radius:5px;border-collapse:collapse;min-width:16em;-moz-border-radius:10px;-webkit-border-radius:10px;}
fieldset.sw{overflow:auto;padding:0px 10px 10px 10px;border:1px solid black;margin-top:10px;border-radius:5px;border-collapse:collapse;display:inline;}
div.swlabel{ float:left;margin-right:1em;overflow:hidden; font-size:0.9em; margin-top:0.2em;padding-top:0.2em}
fieldset.blk{overflow:visible;border:0;margin-right:1em;border-radius:5px;border-collapse:collapse;}
label.col1{float:left;width:5.5em;padding-top:.3em;text-align:left;margin-right:1.5em;}
input{display:block;font-size:1em;margin-bottom:.8em;border:.1em solid #000;padding:.5em;width:15em;border-radius:5px;width:72%;}
input[type=button]{width:6em;display:inline;margin-left:.70em;float:right;padding:.4em;cursor:pointer;}
input[type=button].directset{
    width:4.3em;
    display:inline;
    margin:0.3em;
    margin-top:0;
    margin-left:0.70em;
    float:right;
    font-size:0.6em;
    padding: 0.2em;
    cursor:pointer;
}
.onoffswitch{position:relative;width:90px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;margin-left:.5em;margin-right:.2em;}
.onoffswitch-checkbox{display:none;}
.onoffswitch-label{display:block;overflow:hidden;cursor:pointer;border:2px solid #999;border-radius:20px;}
.onoffswitch-inner{display:block;width:200%;margin-left:-100%;transition:margin .3s ease-in 0s;}
.onoffswitch-inner:before,.onoffswitch-inner:after{display:block;float:left;width:50%;height:1.9em;padding:0;line-height:1.9em;font-size:14px;color:white;font-family:Trebuchet,Arial,sans-serif;font-weight:bold;box-sizing:border-box;}
.onoffswitch-inner:before{content:"ON";padding-left:10px;background-color:#E6E65F;color:#000;}
.onoffswitch-inner:after{content:"OFF";padding-right:10px;background-color:#EEE;color:#999;text-align:right;}
.onoffswitch-switch{display:block;width:18px;margin:6px;background:gray;position:absolute;top:0;bottom:0;right:56px;border:2px solid #999;border-radius:20px;transition:all .3s ease-in 0s;}
.onoffswitch-checkbox:checked+.onoffswitch-label .onoffswitch-inner{margin-left:0;}
.onoffswitch-checkbox:checked+.onoffswitch-label .onoffswitch-switch{right:0;}


html,body{font-family:Verdana,sans-serif;margin:0;padding:0;}
#background{position:absolute;width:100%;top:80px;z-index:-1;height:80%;background-image:url('../img/background.gif');}
html{overflow-x:hidden;}

.top{height:68px;padding-top:3px;padding-left:10px;line-height:50px;overflow:hidden;font-size:15px;}
#main{overflow:auto;display:none;}
#menubtn{float:left;font-size:1.2rem;margin:0;padding:0;}
#nav_translate a{display:inline;}
.section{padding:4%;}
.section p{color:#555;font-size:30px;margin:0 0 10px!important;}
.w3-code{padding:12px 16px;border-left:4px solid #4CAF50!important;}
.sectionbtn{background-color:#555;margin:10px 5px 5px 5px;}
#sidemenu{margin-top:-2.5em;background-color:white;overflow:auto;height:400px;}
#menuoffsw{float:right;border-style:solid;margin:2px;border-width:1px;width:1em;height:1em;padding:1px;text-align:center;display:none;cursor:pointer;border-radius:2px;background-color:silver;}
h1,h2{margin-top:0;margin-bottom:2px;}
@media only screen and(min-width :200px){body{font-size:16px;}
}
@media only screen and(min-width :641px){.top{height:68px;display:block;}
body{font-size:17px;}
#menubtn{display:none;}
}
@media only screen and(min-width :1100px){#main{margin-left:230px;}
body{font-size:18px;}
#sidemenu{width:230px;display:block;}
}
@media screen and(max-width:640px){.top{height:68px;display:none;}
.toptext{display:none;}
.w3-dropnav .w3-col{height:auto;}
}
a{color:inherit;text-decoration:none!important;}
.w3-navbar .w3-opennav.w3-right{float:right!important;}
.w3-topnav{padding:8px 8px;}
.topnavlinks{padding:8px 8px;white-space:nowrap;font-size:1.3em}
.w3-sidenav{height:100%;width:200px;background-color:#fff;position:fixed!important;z-index:1;overflow:auto;}
.w3-sidenav a{padding:4px 2px 4px 16px;}
.w3-sidenav a:hover{background-color:#ccc;}
.w3-sidenav a,.w3-dropnav a{display:block;}
.w3-sidenav .w3-dropdown-hover:hover,.w3-sidenav .w3-dropdown-hover:first-child,.w3-sidenav .w3-dropdown-click:hover{background-color:#ccc;color:#000;}
.w3-sidenav .w3-dropdown-hover,.w3-sidenav .w3-dropdown-click{width:100%;}
.w3-sidenav .w3-dropdown-hover .w3-dropdown-content,.w3-sidenav .w3-dropdown-click .w3-dropdown-content{min-width:100%;}
.w3-card{border:1px solid #ccc;}
.w3-card-2,.w3-example{box-shadow:0 2px 4px 0 rgba(0,0,0,0.16),0 2px 10px 0 rgba(0,0,0,0.12)!important;}
.w3-card-4,.w3-hover-shadow:hover{box-shadow:0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19)!important;}
.w3-card-2{box-shadow:0 2px 4px 0 rgba(0,0,0,0.16),0 2px 10px 0 rgba(0,0,0,0.12)!important;}
.w3-navbar a,.w3-topnav a,.w3-sidenav a,a{text-decoration:none!important;}
.w3-left-align{text-align:left!important;}
.w3-right-align{text-align:right!important;}
.w3-theme{color:#fff!important;background-color:#4CAF50!important;}
#menubtn{font-size:2.5rem;}
#mon{font-size:.8rem;}
#msg{font-size:.9rem;}
.work-div{position:absolute;margin:auto;margin-top:22%;margin-right:10%;top:0;right:0;bottom:0;left:0;width:50%;height:50%;background-color:#ccc;border-radius:5px;}
table.formtable{margin:0;padding:0;width:100%;border-collapse:collapse;}
table.formtable tr td{padding:5px;}
#restart{cursor:pointer;}
.logonoff{cursor:pointer;display:none;}
</style>
</head><body style="position: relative; min-height: 100%; top: 0px;"><div id=background></div>
<div id='designhead' class="top">
   <img src="../img/ThIN-mini.gif" height=60><font size=+3> ThIN - Technologie</font>
   <!--
   <div class="w3-right toptext w3-wide">Top Optional Data</div>
   -->
</div>

<div id='topnavbar' class="w3-theme w3-card-2 w3-topnav w3-right-align w3-slim">
  <div id="menubtnbox">
  <a id="menubtn" href="javascript:void(0);" class="w3-left" title="Menu">&equiv;</a>
  </div>
  <div class="topnavlinks">
  <span id=thinlabel></span><span id=hostname></span>
  &nbsp; <!-- hier kann noch was rein -->
  <span class=logonoff id=logonBtn>
  &bull; Logon &bull;
  </span>
  <span class=logonoff id=logoffBtn>
  &bull; Logoff &bull;
  </span>
  </div>
</div>


<nav id="sidemenu" class="w3-sidenav w3-card-2 w3-animate-left" style="display: none;">
<div id=menuoffsw><b>X</b></div>
<div style="margin:15px" id=menu></div>

<div style='position:absolute;bottom:2px;width:inherit'>
<div id=msg style='margin-left:10px;margin-right:10px'></div>
<div id=mon style='border-width:1px;border-style:solid;border-color:gray;margin:10px;padding:5px'>Connecting ...</div>
</div>
</nav>

<div id="main" style="margin-left: 0%; transition: 0.4s;">
<div style='middle;text-align:center;margin-top:90px'>
<img src="/img/ThIN.gif" height=240 width=240>
</div>
<!--
  <div class="w3-col l6 section"><h1>HTML</h1>XX</div>
  <div class="w3-col l6 section">
    <div class="w3-example w3-padding-hor-16 w3-margin-0">
    <div class="w3-code htmlHigh notranslate">
Dies ist die Hilfe zu dem links angezeigten Men√º
    </div>
  </div>
-->
</div>
<script language="JavaScript">

function formatBytes(bytes,decimals){
   if(bytes == 0) return '0 Byte';
   var k = 1000;
   var dm = decimals + 1 || 3;
   var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
   var i = Math.floor(Math.log(bytes) / Math.log(k));
   var s=parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) +' '+sizes[i];
   s=s.replace(".",",");
   return(s);
}

function formatSeconds(sec){
   var s="";

   var days = parseInt( sec / 86400 );
   var hours = parseInt( sec / 3600 ) % 24;
   var minutes = parseInt( sec / 60 ) % 60;
   var seconds = sec % 60;
   if (days>0){
      s+=days+"d "
      if (hours>0){
         s+=hours+"h "
      }
      if (minutes>0){
         s+=minutes+"m "
      }
   }
   else{
      if (hours>0){
         s+=hours+"h "
      }
      if (minutes>0){
         s+=minutes+"m "
      }
      if (seconds>0){
         s+=seconds+"s "
      }
   }
   return(s);
}

</script>
<script language="JavaScript">
var App;
var spinner;
function SpinnerOn(){
   if (spinner==undefined || spinner.el==undefined){
      if (Spinner){
         spinner = new Spinner().spin();
         document.getElementsByTagName('body')[0].appendChild(spinner.el);
      }
   }
}
function SpinnerOff(){
   spinner.stop();
}
SpinnerOn();
requirejs.config({
   baseUrl: '/js',
   waitSeconds: 60,
   paths: {
      jquery: 'jquery.min',
      action: '/jsact/handler'
   }
});
requirejs.onError=function(e){
   console.log("requirejs.onError",e);
   SpinnerOff();
};
document.CurrentObject=undefined;

var FRM={
 form:function(id,d){
    return("<form id=\""+id+"\">"+d+"</form>");
 },
 fset:function(id,legend,d){
    return("<fieldset class=main id=\""+id+"\">"+
           "<legend>"+legend+"</legend><div>"+
           d+"</div></fieldset>");
 },
 fblk:function(d){
    return("<fieldset class=\"blk\">"+
           d+"</fieldset>");
 },
 fld:function(type,id,label,help){
    return("<label class=col1 for=\""+id+"\">"+label+"</label>"+
           "<input type=\""+type+"\" name=\""+id+"\""+
           " id=\""+id+"\">");
 },
 swi:function(t,id,ro,label,help,width){
    var d="<fieldset class=sw>"+
          "<legend>"+label+"</legend>"+
          "<div class=\"swlabel\">"+help;
    if (!ro){
       d+="<input class=directset devst=\"1\" "+
          "devname=\""+id+"\" type=button value=\"set on\">"+
          "<input class=directset devst=\"0\" "+
          "devname=\""+id+"\" type=button value=\"set off\">";
    }
    d+="</div><div";
    if (width!=""){
       d+=" style=\"margin-left:"+width+"\"  ";
    }
    d+=" class=\"onoffswitch\">"+
       "<input type=\"checkbox\" name=\""+id+"\" ";
    if (ro){
       d+="disabled readonly ";
    }
    d+="class=\"onoffswitch-checkbox\" id=\""+id+"\">"+
       "<label class=\"onoffswitch-label\" for=\""+id+"\">"+
       "<span class=\"onoffswitch-inner\"></span>"+
       "<span class=\"onoffswitch-switch\"></span>"+
       "</label></div></fieldset>";
    return(d);
 },

 btn:function(id,label,width){
    d="<input type=button id=\""+id+"\" value=\""+label+"\"";
    if (width!=""){
       d+=" style='width:"+width+"'";
    }
    d+=">";
    return(d);
 }
}

require(["jquery"],function($){
   function startSubApp(id){
      if (id=="main"){
         if (document.CurrentObject){
            document.CurrentObject.end();
         }
         document.CurrentObject=undefined;
         window.location.hash="";
      }
      else{
         console.log("startSubApp",id);
         SpinnerOn();
         require(['action/'+id],function(o){
            if (o){
               console.log("loaded object=",o);
               if (document.CurrentObject){
                  document.CurrentObject.end();
                  $("#main").fadeOut(400);
               }
               document.CurrentObject=o;
               window.location.hash="#"+id;
               console.log("loaded object=",o);
               document.CurrentObject.start();
               $("#main").fadeIn(400,function(){
                  SpinnerOff();
               });
            }
         });
         if ($("#sidemenu").attr('mode')=='fullscreen'){
            NaviClose();
         }
      }
   }
   App={
      session:{
         authLevel:0,
         user:"anonymous",
      },
      startMenu:function(){
      //   console.log("startMenu");
      },
      showMsg:function(txt){
         var htmltxt=txt;
         $('#msg').html(htmltxt);
      },
      isLoggedOn:function(){
         $('#logonBtn').hide();
         $('#logoffBtn').show();
         $('#logoffBtn').click(function(){
            SpinnerOn();
            console.log("logoff clicked");
            $.ajax({
              type: "POST",
              url: '/jssys/logoff',
              data: "",
              success: function(data,textStatus,jqXHR){
                 if (data.exitcode>0){
                    alert("error "+data.exitmsg);
                 }
                 else{
                    console.log("logon OK",data,textStatus,jqXHR);
                    document.location.href="../../html/index.html";
                 }
                 SpinnerOff();
              },
              error: function(xreq,textStatus,errorThrown){
                 console.log("logon ERROR textStatus:",
                             textStatus,"error:",errorThrown," xreq",xreq);
                 SpinnerOff();
              },
              dataType: "json"
            });
         });

      },
      isLoggedOut:function(){
         $('#logonBtn').show();
         $('#logoffBtn').hide();
         $('#logonBtn').click(function(){
            $("#main").html(
               FRM.form('formLogon',FRM.fset('fset1','ThIN System Logon',
               FRM.fld('text','username','Username:','')+   
               FRM.fld('password','password','Password:','')+   
               FRM.fblk(FRM.btn('doLogon','Logon'))))
            );
            $('#doLogon').click(function(){
               var str=$("#formLogon").serialize();
               SpinnerOn();
               $.ajax({
                 type: "POST",
                 url: '/jssys/logon',
                 data: str,
                 success: function(data,textStatus,jqXHR){
                    if (data.exitcode>0){
                       alert("error "+data.exitmsg);
                    }
                    else{
                       console.log("logon OK",data,textStatus,jqXHR);
                       document.location.href="../../html/index.html";
                    }
                    SpinnerOff();
                 },
                 error: function(xreq,textStatus,errorThrown){
                    console.log("logon ERROR textStatus:",
                                textStatus,"error:",errorThrown," xreq",xreq);
                    SpinnerOff();
                 },
                 dataType: "json"
               });

            });
         });
      },
      endMenu:function(){
         $('.navlink').click(function(e){
            var id=$(this).attr('id');
            startSubApp(id);
            return(false);
         });
      },
      addHeader:function(id,text){
        var d="";
        d+="<h2><span id="+id+">"+text+"</span></h2>";
        return(d);
      },
      addEntry:function(id,text){
        var d="";
        d+="<a id='"+id+"' class='navlink' href=\"javascript:void(0);\">"+
           text+"</a>";
        return(d);
      }

   };
   App.ws=new WebSocket("ws://" + location.host + ":81/");
   App.ws.onmessage = function(evt) {
      if (document.CurrentObject && document.CurrentObject.handleSystemEvent){
         document.CurrentObject.handleSystemEvent(evt);
      }
   };
   App.postSystemEvent=function(ev){
      App.ws.send(ev);
   };
   //console.log("ws=",App.ws);
   function NaviOpen() {
     if ($(window).width()>640){
        $("#main").css({marginLeft:"230px"});
        $("#sidemenu").css({width:"230px"});
        $("#main").css({transition:"400ms"});
        $("#sidemenu").show();
        $("#sidemenu").attr('mode','normal');
     }
     else{
        $("#sidemenu").css({width:"100%"});
        $("#sidemenu").show();
        $("#sidemenu").attr('mode','fullscreen');
        $('#menuoffsw').show();
        $('#menuoffsw').click(function(){
           NaviClose();
        });
     }
     $('#menubtnbox').css({visibility:'hidden'});
   }

   function NaviClose() {
     $("#main").css({marginLeft:"0%"});
     $("#sidemenu").hide();
     $('#menubtnbox').css({visibility:'visible'});
     $('#menuoffsw').hide();
   }

   function doControlNavigation(){
      require(["MenuTab"],function(MenuTab){
         App.startMenu();
         $('#menu').html(MenuTab.recreate());
         App.endMenu();
      });

      var h=$(window).height();
      var w=$(window).width();
      if (w<640){
         NaviClose();
      }
      else{
         NaviOpen();
      }
      if (w<740){
         $('#thinlabel').html("ThIN");
      }
      else{
         $('#thinlabel').html("ThIN - Technologie");
      }
      if (h<=640 || w<550){
         $('#designhead').hide();
      }
      else{
         $('#designhead').show();
         h-=$('#designhead').height();
      }
      h-=$('#topnavbar').height();
      // test $("#main").height(h-40);
   }
   function updateSystemStatus(data){
       var d="";
       if (data.UpTime!=undefined){
          d+="UpTime: "+formatSeconds(data.UpTime)+"<br>";
       }
       if (data.FreeHeap!=undefined){
          d+="FreeHeap: "+formatBytes(data.FreeHeap,1)+"<br>";
       }
       if (data.FreeSpace!=undefined){
          d+="FreeSpace: "+formatBytes(data.FreeSpace,1)+"<br>";
       }
       if (data.SketchSize!=undefined){
          d+="SketchSize: "+formatBytes(data.SketchSize,1)+"<br>";
       }
       if (data.Load!=undefined){
          d+="Performance: "+(Math.round(1000000000/data.Load))+" Loops/s<br>";
       }
       if (data.Hostname!=undefined){
          $('#hostname').html(" - Hostname:"+data.Hostname);
       }
       if (data.sessionAuthLevel!=undefined){
          if (App.session.authLevel>0 && data.sessionAuthLevel==0){
             App.showMsg("Note: doing auto logoff");
             App.isLoggedOut();
             setTimeout(function(){
                App.showMsg("");
             },2000);
          }
          var authstatechanged=false;
          if (App.session.authLevel!=data.sessionAuthLevel){
             authstatechanged=true;
             App.session.authLevel=data.sessionAuthLevel;
          }
          if (App.session.user!=data.sessionUser){
             authstatechanged=true;
             App.session.user=data.sessionUser;
          }
          if (authstatechanged){
             doControlNavigation();
             if (data.sessionAuthLevel==0){ // seems to bee autlooged out
                $("#main").html("");
             }
          }
       }

       $('#mon').html(d);
   }

   function refreshStatus(){
      $.ajax({
        dataType: "jsonp",
        accepts: {
             mycustomtype: 'text/json'
        },
        url: "../js/json/WebSrvStatus",
        success:function(data){
           if (data && data.exitcode=="0"){
              updateSystemStatus(data.data);
           }
           setTimeout(refreshStatus, 2000);
        },
        error: function(xreq,textStatus,errorThrown){
           console.log("logon ERROR textStatus:",
                       textStatus,"error:",errorThrown," xreq",xreq);
           setTimeout(refreshStatus, 100);
        },
        jsonp: "callback"
      });
   };

   $(window).resize(doControlNavigation);
   if (document.cookie.indexOf("THINSESSIONID") >= 0) {
      App.isLoggedOn();
   }
   else{
      App.isLoggedOut();
   }
   $(window).ready(function(){
      doControlNavigation();

      $("#menubtn").click(function(e){
         NaviOpen();
         return(false);
      });
      $("#restart").click(function(e){
         window.location.hash='';
         window.location.reload();
         return(false);
      });
      var directload = window.location.hash.substr(1);
      console.log("directload=",directload);
      if (directload!=""){
         startSubApp(directload);   
      }
      else{
         $("#main").fadeIn(400,function(){
            SpinnerOff();
         });
      }
      setTimeout(refreshStatus, 10);
   });
});


</script>
</body>
</html>

